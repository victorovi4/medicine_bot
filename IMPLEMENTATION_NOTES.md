# Implementation Notes

–ó–∞–º–µ—Ç–∫–∏ –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –∫–∞—Ä—Ç—ã –¥–ª—è –ò–æ—Ñ—Ñ–µ –í.–ë.

## üìã –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —ç—Ç–∞–ø—ã

### –≠—Ç–∞–ø 1: –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚úÖ
- Next.js 16 + TypeScript + Tailwind CSS
- Prisma ORM + Vercel Postgres
- Vercel Blob –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
- shadcn/ui –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- CRUD –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (API + UI)
- –°—Ç—Ä–∞–Ω–∏—Ü—ã: –≥–ª–∞–≤–Ω–∞—è (timeline), –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ, –ø—Ä–æ—Å–º–æ—Ç—Ä, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –≠—Ç–∞–ø 2: AI-–∞–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ ‚úÖ
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Claude —á–µ—Ä–µ–∑ OpenRouter API
- –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (—Ñ–æ—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)
- –ê–Ω–∞–ª–∏–∑ PDF —Ñ–∞–π–ª–æ–≤
- –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –∏–∑ AI-–æ—Ç–≤–µ—Ç–∞
- **–ò–∑–≤–ª–µ–∫–∞–µ–º—ã–µ –ø–æ–ª—è:**
  - –¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞, –Ω–∞–∑–≤–∞–Ω–∏–µ, –¥–∞—Ç–∞
  - –í—Ä–∞—á, —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å, –∫–ª–∏–Ω–∏–∫–∞
  - **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ –≤—Ä–∞—á–∞** (–¥–æ—Å–ª–æ–≤–Ω–æ)
  - **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏** (—Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á)
  - AI-—Ä–µ–∑—é–º–µ (–∫—Ä–∞—Ç–∫–∏–π –ø–µ—Ä–µ—Å–∫–∞–∑)
  - –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
  - –¢–µ–≥–∏

### –≠—Ç–∞–ø 3: Telegram –±–æ—Ç ‚úÖ
- Webhook –Ω–∞ `/api/telegram/webhook`
- –ö–æ–º–∞–Ω–¥—ã: `/start`, `/help`, `/status`, `/last`
- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –∏ PDF
- AI-–∞–Ω–∞–ª–∏–∑ –∏ –∞–≤—Ç–æ–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–∞—Ä—Ç—É

---

## üîß –ö–ª—é—á–µ–≤—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è

### Telegram: –ú–Ω–æ–≥–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ –æ–¥–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞.

**–†–µ—à–µ–Ω–∏–µ:** –ö–æ–º–∞–Ω–¥–∞ `/batch` –¥–ª—è —Ä—É—á–Ω–æ–π –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏:
```
/batch     ‚Äî –Ω–∞—á–∞—Ç—å —Å–±–æ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü (—Å–æ–∑–¥–∞—ë—Ç –º–∞—Ä–∫–µ—Ä __batch_marker__)
[—Ñ–æ—Ç–æ 1]   ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ BatchPending
[—Ñ–æ—Ç–æ 2]   ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ BatchPending
/done      ‚Äî –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞–∫ –æ–¥–∏–Ω –¥–æ–∫—É–º–µ–Ω—Ç
/cancel    ‚Äî –æ—Ç–º–µ–Ω–∏—Ç—å —Å–±–æ—Ä
```

**–ü–æ—á–µ–º—É –Ω–µ media_group_id:**
- Telegram –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç media_group_id —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ—Ç–æ —Ä–∞–∑–æ–º –∏–∑ –≥–∞–ª–µ—Ä–µ–∏
- –ü—Ä–∏ –ø–µ—Ä–µ—Å—ã–ª–∫–µ –∏–∑ –¥—Ä—É–≥–æ–≥–æ —á–∞—Ç–∞ media_group_id —Ç–µ—Ä—è–µ—Ç—Å—è
- `/batch` —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ

### Telegram: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
**–ü—Ä–æ–±–ª–µ–º–∞:** –û–¥–∏–Ω –¥–æ–∫—É–º–µ–Ω—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω –¥–≤–∞–∂–¥—ã.

**–†–µ—à–µ–Ω–∏–µ:** –ü–æ—Å–ª–µ AI-–∞–Ω–∞–ª–∏–∑–∞ –∏—â–µ–º –ø–æ—Ö–æ–∂–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:
- –î–∞—Ç–∞ ¬±3 –¥–Ω—è
- –¢–æ—Ç –∂–µ —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞
- –ú–∏–Ω–∏–º—É–º 2 –æ–±—â–∏—Ö —Å–ª–æ–≤–∞ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ (–¥–ª–∏–Ω–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤)

–ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º inline-–∫–Ω–æ–ø–∫–∏:
- ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞–∫ –Ω–æ–≤—ã–π
- üîÑ –ó–∞–º–µ–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
- ‚ùå –û—Ç–º–µ–Ω–∞

**–¢–∞–±–ª–∏—Ü—ã:**
- `BatchPending` ‚Äî –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü –ø—Ä–∏ `/batch`
- `PendingDocument` ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç –æ–∂–∏–¥–∞—é—â–∏–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–¥–ª—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)

### AI: –ü–∞—Ä—Å–∏–Ω–≥ JSON
**–ü—Ä–æ–±–ª–µ–º–∞:** Claude –∏–Ω–æ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON –∏–ª–∏ –æ–±—ë—Ä—Ç—ã–≤–∞–µ—Ç –≤ markdown.

**–†–µ—à–µ–Ω–∏–µ:** –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π –ø–∞—Ä—Å–∏–Ω–≥:
1. –£–±–∏—Ä–∞–µ–º ```json –æ–±—ë—Ä—Ç–∫–∏
2. –ü—ã—Ç–∞–µ–º—Å—è JSON.parse –Ω–∞–ø—Ä—è–º—É—é
3. –ò—â–µ–º `{...}` –≤ —Ç–µ–∫—Å—Ç–µ —á–µ—Ä–µ–∑ regex
4. –ï—Å–ª–∏ –≤—Å—ë –Ω–µ —É–¥–∞–ª–æ—Å—å ‚Äî —Å–æ–∑–¥–∞—ë–º –±–∞–∑–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å —Ç–µ–≥–æ–º "—Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏"

### AI: –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
**–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:** –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –≤—Ä–∞—á–∞ ‚Äî –¥–æ—Å–ª–æ–≤–Ω–æ, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ‚Äî —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á.

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- –ü–æ–ª–µ `conclusion` ‚Äî –¥–æ—Å–ª–æ–≤–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞
- –ü–æ–ª–µ `recommendations` ‚Äî –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫
- –í –ø—Ä–æ–º–ø—Ç–µ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω–æ: "–∏–∑–≤–ª–µ–∫–∞–π –î–û–°–õ–û–í–ù–û, –Ω–µ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä—É–π"

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### Document
```prisma
model Document {
  id              String    @id @default(uuid())
  date            DateTime
  type            String    // –∞–Ω–∞–ª–∏–∑, —É–∑–∏, –∫—Ç, –º—Ä—Ç, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è, –≤—ã–ø–∏—Å–∫–∞...
  title           String
  doctor          String?
  specialty       String?
  clinic          String?
  summary         String?   // AI-—Ä–µ–∑—é–º–µ
  conclusion      String?   // –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –≤—Ä–∞—á–∞ (–¥–æ—Å–ª–æ–≤–Ω–æ)
  recommendations String[]  // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (—Å–ø–∏—Å–æ–∫)
  content         String?
  fileUrl         String?
  fileName        String?
  fileType        String?
  tags            String[]
  keyValues       Json?
  createdAt       DateTime
  updatedAt       DateTime
}
```

### BatchPending
```prisma
model BatchPending {
  id         String   @id @default(uuid())
  chatId     BigInt
  fileUrl    String   // URL —Ñ–∞–π–ª–∞ –∏–ª–∏ "__batch_marker__"
  fileType   String
  receivedAt DateTime @default(now())
}
```

### PendingDocument
```prisma
model PendingDocument {
  id           String   @id @default(uuid())
  chatId       BigInt
  messageId    Int?     // ID —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–Ω–æ–ø–∫–∞–º–∏
  documentData Json     // –í—Å–µ –ø–æ–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
  duplicateId  String?  // ID —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –¥—É–±–ª–∏–∫–∞—Ç–∞
  createdAt    DateTime
  expiresAt    DateTime // –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 1 —á–∞—Å
}
```

---

## üîë –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
DATABASE_URL=postgres://...

# Vercel Blob
BLOB_READ_WRITE_TOKEN=...

# AI (OpenRouter)
OPENROUTER_API_KEY=...

# Telegram
TELEGRAM_BOT_TOKEN=...
TELEGRAM_ALLOWED_USERS=123456789,987654321  # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
NEXT_PUBLIC_APP_URL=https://medicine-bot-4xqt.vercel.app

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
TEST_DATABASE_URL=...  # –æ—Ç–¥–µ–ª—å–Ω–∞—è –ë–î –¥–ª—è e2e —Ç–µ—Å—Ç–æ–≤
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit-—Ç–µ—Å—Ç—ã (Vitest)
```bash
npm run test
```
- `src/tests/types.test.ts` ‚Äî normalizeDocumentType
- `src/tests/telegram.test.ts` ‚Äî isUserAllowed
- `src/tests/utils.test.ts` ‚Äî cn utility

### E2E-—Ç–µ—Å—Ç—ã (Playwright)
```bash
npm run test:e2e           # –ª–æ–∫–∞–ª—å–Ω–æ
npm run test:e2e:prod      # –Ω–∞ –ø—Ä–æ–¥–µ –≤ test-mode
```
- –°–æ–∑–¥–∞—é—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ API
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç `x-test-mode` header / `test_mode` cookie
- –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –æ—Ç production –¥–∞–Ω–Ω—ã—Ö

### GitHub Actions
–ü—Ä–∏ push –≤ main:
1. Unit-—Ç–µ—Å—Ç—ã
2. E2E-—Ç–µ—Å—Ç—ã –Ω–∞ –ø—Ä–æ–¥–µ (test-mode)

---

## ‚ö†Ô∏è –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **AI-–∞–Ω–∞–ª–∏–∑ —Ä—É–∫–æ–ø–∏—Å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤** ‚Äî –∫–∞—á–µ—Å—Ç–≤–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑–±–æ—Ä—á–∏–≤–æ—Å—Ç–∏ –ø–æ—á–µ—Ä–∫–∞
2. **–ë–æ–ª—å—à–∏–µ PDF** ‚Äî –º–æ–≥—É—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å –ª–∏–º–∏—Ç—ã —Ç–æ–∫–µ–Ω–æ–≤ Claude
3. **Telegram file size** ‚Äî Telegram –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤ (20 MB –¥–ª—è –±–æ—Ç–æ–≤)
4. **PendingDocument expiration** ‚Äî –Ω–µ—Ç –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π (–Ω—É–∂–µ–Ω cron)

---

## üìù –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

### 2026-01-23
- –î–æ–±–∞–≤–ª–µ–Ω `/batch` –¥–ª—è –º–Ω–æ–≥–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Å inline-–∫–Ω–æ–ø–∫–∞–º–∏
- –£–ª—É—á—à–µ–Ω –ø–∞—Ä—Å–∏–Ω–≥ JSON –æ—Ç AI

### 2026-01-22
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è `conclusion` –∏ `recommendations`
- GitHub Actions –¥–ª—è –∞–≤—Ç–æ—Ç–µ—Å—Ç–æ–≤
- Test-mode –¥–ª—è e2e –Ω–∞ –ø—Ä–æ–¥–µ

### 2026-01-21
- Telegram –±–æ—Ç (—ç—Ç–∞–ø 3)
- –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ OpenRouter API

### 2026-01-20
- AI-–∞–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (—ç—Ç–∞–ø 2)
- –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (—ç—Ç–∞–ø 1)
