generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

model Document {
  id        String   @id @default(uuid())
  
  // Основная информация
  date      DateTime                    // Дата документа (когда сделан анализ/приём)
  category  String                      // Категория: "заключения", "анализы", "исследования"
  subtype   String                      // Подтип: "консультация", "кровь", "кт" и т.д.
  title     String                      // Заголовок: "Биохимия крови", "КТ брюшной полости"
  
  // Где и кто
  doctor    String?                     // ФИО врача
  specialty String?                     // Специальность: "уролог", "онколог", "терапевт"
  clinic    String?                     // Медучреждение
  
  // Содержимое
  summary   String?  @db.Text           // AI-резюме (краткий пересказ)
  conclusion String? @db.Text           // Заключение врача (дословная цитата из документа)
  recommendations String[] @default([]) // Рекомендации врача (список задач для пациента)
  content   String?  @db.Text           // Полный текст/расшифровка
  
  // Файл
  fileUrl   String?                     // URL файла в Vercel Blob
  fileName  String?                     // Оригинальное имя файла
  fileType  String?                     // MIME тип: "application/pdf", "image/jpeg"
  
  // Структурированные данные
  tags      String[]                    // Теги: ["онкология", "ПСА", "простата"]
  keyValues Json?                       // Ключевые показатели: {"ПСА": "4.5 нг/мл", "гемоглобин": "130 г/л"}
  
  // Мета
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([date])
  @@index([category])
  @@index([subtype])
  @@index([title])
}

// Временное хранилище для режима /batch — сбор страниц документа
model BatchPending {
  id         String   @id @default(uuid())
  chatId     BigInt   // Telegram Chat ID
  fileUrl    String   // URL загруженного файла в Vercel Blob
  fileType   String   // MIME тип
  receivedAt DateTime @default(now())
  
  @@index([chatId])
}

// Ожидающий подтверждения документ (для проверки дубликатов)
model PendingDocument {
  id              String   @id @default(uuid())
  chatId          BigInt   // Telegram Chat ID
  messageId       Int?     // ID сообщения с кнопками (для редактирования)
  
  // Данные документа (JSON)
  documentData    Json     // Все поля документа
  
  // Найденный дубликат
  duplicateId     String?  // ID существующего документа-дубликата
  
  createdAt       DateTime @default(now())
  expiresAt       DateTime // Автоудаление через 1 час
  
  @@index([chatId])
}
