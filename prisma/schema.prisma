generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

model Document {
  id        String   @id @default(uuid())
  
  // Основная информация
  date      DateTime                    // Дата документа (когда сделан анализ/приём)
  category  String                      // Категория: "заключения", "анализы", "исследования"
  subtype   String                      // Подтип: "консультация", "кровь", "кт" и т.д.
  title     String                      // Заголовок: "Биохимия крови", "КТ брюшной полости"
  
  // Где и кто
  doctor    String?                     // ФИО врача
  specialty String?                     // Специальность: "уролог", "онколог", "терапевт"
  clinic    String?                     // Медучреждение
  
  // Содержимое
  summary   String?  @db.Text           // AI-резюме (краткий пересказ)
  conclusion String? @db.Text           // Заключение врача (дословная цитата из документа)
  recommendations String[] @default([]) // Рекомендации врача (список задач для пациента)
  content   String?  @db.Text           // Полный текст/расшифровка
  
  // Файл
  fileUrl   String?                     // URL файла в Vercel Blob
  fileName  String?                     // Оригинальное имя файла
  fileType  String?                     // MIME тип: "application/pdf", "image/jpeg"
  
  // Структурированные данные
  tags      String[]                    // Теги: ["онкология", "ПСА", "простата"]
  keyValues Json?                       // Ключевые показатели: {"ПСА": "4.5 нг/мл", "гемоглобин": "130 г/л"}
  
  // Связи
  measurements Measurement[]            // Извлечённые числовые показатели
  
  // Мета
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([date])
  @@index([category])
  @@index([subtype])
  @@index([title])
}

// Измерение показателя (для графиков динамики)
model Measurement {
  id          String   @id @default(uuid())
  
  // Связь с документом-источником
  documentId  String
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  // Данные измерения
  name        String   // "ПСА общий", "Гемоглобин"
  value       Float    // Числовое значение: 4.5, 130
  unit        String   // Единицы: "нг/мл", "г/л"
  date        DateTime // Дата измерения (из документа)
  
  createdAt   DateTime @default(now())
  
  @@index([name, date])
  @@index([documentId])
}

// Временное хранилище для режима /batch — сбор страниц документа
model BatchPending {
  id         String   @id @default(uuid())
  chatId     BigInt   // Telegram Chat ID
  fileUrl    String   // URL загруженного файла в Vercel Blob
  fileType   String   // MIME тип
  receivedAt DateTime @default(now())
  
  @@index([chatId])
}

// Ожидающий подтверждения документ (для проверки дубликатов)
model PendingDocument {
  id              String   @id @default(uuid())
  chatId          BigInt   // Telegram Chat ID
  messageId       Int?     // ID сообщения с кнопками (для редактирования)
  
  // Данные документа (JSON)
  documentData    Json     // Все поля документа
  
  // Найденный дубликат
  duplicateId     String?  // ID существующего документа-дубликата
  
  createdAt       DateTime @default(now())
  expiresAt       DateTime // Автоудаление через 1 час
  
  @@index([chatId])
}

// Кэш выписки 027/у
model CachedExtract {
  id              String   @id @default(uuid())
  
  // Период выписки
  periodFrom      DateTime
  periodTo        DateTime
  
  // Контент выписки (JSON)
  content         Json     // ExtractData объект
  
  // Метаданные
  documentsCount  Int      // Сколько документов было в выписке
  generatedAt     DateTime @default(now())
  
  @@unique([periodFrom]) // Одна выписка на период лечения
}

// ============================================
// ДНЕВНИК ПАЦИЕНТА
// ============================================

// Запись симптома
model Symptom {
  id          String   @id @default(uuid())
  datetime    DateTime // Дата + время появления симптома
  name        String   // "Головная боль", "Тошнота", "Слабость"
  intensity   Int?     // Интенсивность 1-10 (опционально)
  duration    String?  // "2 часа", "весь день"
  notes       String?  @db.Text // Комментарий
  
  createdAt   DateTime @default(now())
  
  @@index([datetime])
  @@index([name])
}

// Показатель здоровья (температура, давление, пульс)
model VitalSign {
  id          String   @id @default(uuid())
  datetime    DateTime // Дата + время измерения
  type        String   // "temperature", "pressure", "pulse", "weight", "spo2"
  value       Float    // Основное значение (36.6, 120, 72)
  value2      Float?   // Второе значение (для давления: 80)
  unit        String   // "°C", "мм рт.ст.", "уд/мин", "кг", "%"
  notes       String?  // Комментарий
  
  createdAt   DateTime @default(now())
  
  @@index([datetime])
  @@index([type])
}

// Препарат, который принимает пациент
model Medication {
  id          String   @id @default(uuid())
  name        String   // "Преднизолон", "Энтеросгель"
  dosage      String?  // "5 мг", "1 таблетка"
  frequency   String?  // "2 раза в день", "утром и вечером"
  startDate   DateTime // Когда начал принимать
  endDate     DateTime? // Когда закончил (null = продолжает)
  notes       String?  @db.Text
  isActive    Boolean  @default(true) // Активный препарат
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([isActive])
  @@index([startDate])
}
